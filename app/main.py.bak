from fastapi.responses import JSONResponse
# hairfusion-service/app/main.py
from __future__ import annotations

import asyncio
from typing import Optional, Dict, Any

from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, PlainTextResponse
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel
from urllib.parse import quote

from app.settings import settings

# ---- AILabTools (2D 헤어 합성) ----
from app.services.ailabtools import (
    hairstyle_edit_pro,
    AILabError,
    AILabAuthError,
    AILabBadReq,
)

# ---- Meshy (2D → 3D 변환) ----
from app.services.meshy import (
    start_image_to_3d,
    poll_job_until_done,
    download_result_assets,
    MeshyError,
    MeshyAuthError,
    MeshyBadReq,
    MeshyTimeout,
)

app = FastAPI(title="hairfusion-service", version="1.0.0")

# CORS: settings.allowed_origins 가 없을 수 있으므로 안전 기본값으로 전체 허용
app.add_middleware(
    CORSMiddleware,
    allow_origins=getattr(settings, "allowed_origins", ["*"]),
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 결과 파일(이미지/GLB) 정적 서빙
app.mount("/static", StaticFiles(directory="outputs"), name="static")


# ---------- Schemas ----------
class FuseReq(BaseModel):
    face_url: str
    hair_style: Optional[str] = None
    color: Optional[str] = None
    image_size: Optional[int] = None
    task_type: Optional[str] = "sync"  # "sync" / "async" 등


class MeshifyReq(BaseModel):
    image_url: str


# ---------- Health ----------
@app.get("/health", response_class=PlainTextResponse)
def health() -> str:
    return "ok\n--\nTrue\n"


# ---------- AILabTools: 2D 헤어 합성 ----------
@app.post("/fuse")
async def fuse(req: FuseReq) -> Dict[str, Any]:
    """
    AILabTools를 이용해 2D 헤어스타일 합성 수행.
    합성 결과 이미지를 outputs/ 폴더에 저장하고 파일 경로 반환.
    """
    try:
        saved = await hairstyle_edit_pro(
            face_url=req.face_url,
            hair_style=req.hair_style,
            color=req.color,
            image_size=req.image_size,
            task_type=req.task_type,
        )
        return {"saved_path": saved, "ok": True}
    except AILabAuthError as e:
        raise HTTPException(status_code=401, detail=f"auth error: {str(e)[:400]}")
    except AILabBadReq as e:
        raise HTTPException(status_code=400, detail=f"bad request: {str(e)[:400]}")
    except AILabError as e:
        # 내부 매핑된 예외
        raise HTTPException(status_code=502, detail=f"backend error: {str(e)[:400]}")
    except Exception as e:
        # 예측 불가 예외
        raise HTTPException(status_code=500, detail=f"unexpected: {repr(e)[:400]}")


# ---------- Meshy: 2D → 3D 변환 ----------
@app.post("/meshify")
async def meshify(req: MeshifyReq) -> Dict[str, Any]:
    """
    Meshy에 이미지→3D 작업을 생성하고, 완료될 때까지 폴링하여 결과 GLB 저장 및 경로 반환.
    """
    try:
        # 1) 작업 생성
        async with httpx_client() as client:
            job_id = await start_image_to_3d(client, image_url=req.image_url)

        # 2) 폴링 (완료 대기)
        async with httpx_client() as client:
            result = await poll_job_until_done(
                client,
                job_id=job_id,
                timeout_sec=getattr(settings, "request_timeout", 180),  # 초 단위
                interval_sec=3.0,
            )

        # 3) 결과 자산(GLB/OBJ 등) 다운로드
        async with httpx_client() as client:
            saved_path = await download_result_assets(client, result)

        return {
            "job_id": job_id,
            "saved_path": saved_path,
            "result": result,
        }

    except MeshyAuthError as e:
        raise HTTPException(status_code=401, detail=f"meshy auth: {str(e)[:400]}")
    except MeshyBadReq as e:
        raise HTTPException(status_code=400, detail=f"meshy bad request: {str(e)[:400]}")
    except MeshyTimeout as e:
        raise HTTPException(status_code=504, detail=f"meshy timeout: {str(e)[:400]}")
    except MeshyError as e:
        raise HTTPException(status_code=502, detail=f"meshy error: {str(e)[:400]}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"unexpected: {repr(e)[:400]}")


# ---------- 간단 3D 웹 뷰어 ----------
@app.get("/viewer", response_class=HTMLResponse)
def viewer(file: str) -> str:
    """
    outputs/meshy/<file> 을 <model-viewer>로 브라우저에서 미리보기.
    사용 예) http://127.0.0.1:8100/viewer?file=meshy_abc123.glb
    """
    safe = quote(file)
    return f"""
<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>HairFusion 3D Viewer</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
      html, body {{ height:100%; margin:0; background:#111; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }}
      header {{ padding:10px 16px; background:#181818; border-bottom:1px solid #222; }}
      main {{ height: calc(100% - 52px); }}
      model-viewer {{ width:100%; height:100%; }}
      a {{ color:#9ad; text-decoration:none; }}
      a:hover {{ text-decoration:underline; }}
    </style>
  </head>
  <body>
    <header>
      <strong>HairFusion 3D Viewer</strong>
      &nbsp;·&nbsp;
      <a href="/static/meshy/{safe}" target="_blank">Download GLB</a>
    </header>
    <main>
      <model-viewer
        src="/static/meshy/{safe}"
        ar
        camera-controls
        autoplay
        environment-image="neutral"
        shadow-intensity="0.8"
        exposure="1.0"
      ></model-viewer>
    </main>
  </body>
</html>
    """


# ---------- httpx AsyncClient 헬퍼 ----------
# settings.request_timeout(초)를 httpx timeout으로 사용
import httpx  # 로컬에서만 사용하므로 파일 하단에 import해도 무방

class httpx_client:
    def __init__(self):
        # FastAPI settings는 초 단위. httpx Timeout은 초 단위 float 허용.
        t = float(getattr(settings, "request_timeout", 180))
        self._client = httpx.AsyncClient(timeout=t)

    async def __aenter__(self) -> httpx.AsyncClient:
        return self._client

    async def __aexit__(self, exc_type, exc, tb):
        await self._client.aclose()

